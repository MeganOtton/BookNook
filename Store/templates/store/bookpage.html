{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}

<!-- Book Page content starts here -->
<div class="booktitle-ribbon">
    <h3 class="booktitle">{{ book.booktitle }}</h3>
    <i class="fa-solid fa-heart fa-2xl Save-Book-Info" style="color: #ffffff;"></i>
    <i class="fa-solid fa-gear fa-2xl Options-Book-Info" style="color: #ffffff;"></i>
</div>

<section class="main_purchase_info">
    <div class="bookcover-purchase">
        <img src="{{ book.bookcover.url }}" class="Book-Cover-Image" alt="{{ book.booktitle }}"> 
        
            <div class="purchase-button">
                <!-- Purchase Button  -->
                <!-- When Clicked Will call move_game_to_chosen which will get it from the list and move it to the users purchased list -->
                <form id="id_purchase_book" action="{%url 'move_book' book.booktitle %}" method="post">
                    {% csrf_token %}
                    <button id="purchasedButton" type="submit" class="btn btn-primary Red_purchase_button">£{{ book.bookprice }}</button>
                </form>

                <!-- Check Purchase Button  -->
                <!-- When Clicked Will call check_game_purchased which will check if the game is already in the users purchased list -->
                <!-- This is not displayed and the user can not interact with this, Couldnt find an easier way to automate this so created a button 
                    that is display:none but has a script that on load will click this button automatically calling a python function -->
                <form id="id_check_book_purchased" action="{%url 'check_book_purchased' book.booktitle %}" method="post" style="display: none;">
                    {% csrf_token %}
                    <button id="checkPurchasedButton" type="submit" class="btn btn-primary Red_purchase_button">Check Purchase</button>
                </form>
            </div>
    </div>

    

    <div class="book-info">
        <div class="book-info-top">
            <h5>{{ book.authorname }}</h5>
            <h5>Genres: </h5>
            <p>
                {% for genre in book.genre.all %}
                    {{ genre }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                    No genres available
                {% endfor %}
            </p>
            <h5>{{ book.chapter }} Chapters</h5>
            <h5>{{ book.bookrating }}</h5>
        </div>

        <div class="book-info-bottom-tablet">
            <h5>About:</h5>
            <h5>{{ book.bookdescription }}</h5>
            <h5>Topics</h5>
            <p>
                {% for topics in book.topics.all %}
                    {{ topics }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                    No Topics available
                {% endfor %}
            </p>
        </div>
    </div>
</section>

<div class="book-info-bottom">
    <h5>About:</h5>
    <p>{{ book.bookdescription }}</p>
    <h5>Topics</h5>
    <p>
        {% for topics in book.topics.all %}
            {{ topics }}{% if not forloop.last %}, {% endif %}
        {% empty %}
            No Topics available
        {% endfor %}
    </p>
</div>

<!-- Review Section -->
<div class="review">
    <!-- Review Info -->
    <div>
        <h5>Reviews Total: {{ book.comments.count }}</h5>
        
        <div class="rating">
            {% with total=book.average_rating|default:0 %}
                {% for i in "12345" %}
                    {% if total >= i|add:"0" %}
                        <span>★</span>
                    {% else %}
                        <span>☆</span>
                    {% endif %}
                {% endfor %}
            {% endwith %}
        </div>

    </div>

    <!-- Create A Review -->
    <div class="review">
        <div class="leave-review-header">
            <i class="fa-solid fa-chevron-down fa-2xl toggle-review-form" style="cursor: pointer;"></i>
            <h3>Leave a Review</h3>
        </div>
        <div class="leave-review-form" style="display: none;">
            <div class="card-body">
                <!-- If User is not Signed In -->
                {% if user.is_authenticated %}
                    <!-- If User has Purchased the book -->
                    {% if request.GET.purchased == 'true' %}
                        <h3>Leave a Review:</h3>
                        <p>Posting as: {{ user.username }}</p>
                        <form id="commentForm" method="POST" style="margin-top: 1.3em;">
                            {{ comment_form | crispy }}
                            {% csrf_token %}
                            <button id="submitButton" type="submit" class="btn btn-signup btn-lg">Submit</button>
                        </form>
                    {% endif %}
                    {% if request.GET.purchased == 'false' %}
                        <p>Purchase the Book to leave a Review</p>
                    {% endif %}
                {% else %}
                    <p>Log in to leave a Review</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Reviews Are Listed Here -->
    <div class="comments">
        <h3 class="commentheading">Reviews:</h3>
        <div class="card-body">
            {% for comment in comments %}
            <div class="p-2 comments{% if not comment.approved and comment.author == user %} faded{% elif not comment.approved %} d-none{% endif %}">

                <p class="font-weight-bold">
                    {{ comment.author }} | {{ comment.rating }}/5                       {{ comment.created_on }}
                </p>

                <div>
                    <h4 id="title{{ comment.id }}">{{ comment.title }}</h4>
                    <div id="text{{ comment.id }}" style="font-weight: bold;">{{ comment.body | linebreaks }}</div>
                </div>
                
                

                {% if not comment.approved and comment.author == user %}
                <p class="approval">This Review is awaiting approval</p>
                {% endif %}
                {% if user.is_authenticated and comment.author == user %}
                <button class="btn btn-delete" data-comment_id="{{ comment.id }}">Delete</button>
                <button class="btn btn-edit" data-comment_id="{{ comment.id }}">Edit</button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Review Form -->
    <!-- If user is not logged in as well as if they have not purchased the book they can not create a comment on the book Post -->
    
</div>

<!-- Delete confirmation modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Delete Review?</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            Are you sure you want to delete your Review? This action cannot be undone.
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <a id="deleteConfirm" href="#" class="btn btn-danger">Delete</a>
        </div>
</div>


<!-- Book Page content ends here -->

<div class="fix-footer">
</div>
{% endblock content%}

{% block extras %}

<script>
    document.querySelector('.toggle-review-form').addEventListener('click', function() {
        const form = document.querySelector('.leave-review-form');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
        this.classList.toggle('fa-chevron-down');
        this.classList.toggle('fa-chevron-up');
    });
</script>

<script src="{% static 'js/comments.js' %}"></script>
<script src="{% static 'js/purchase_checker.js' %}"></script>
{% endblock extras %}