{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}

<p>Debug: Number of hidden books: {{ hidden_books|length }}</p>
<p>Debug: Number of user comments: {{ user_comments|length }}</p>
<p>Debug: Total comments: {{ all_comments_count }}</p>
<p>Debug: User comments count: {{ user_comments_count }}</p>

{% if role_updated %}
    <div class="alert success alert-dismissible fade show alert-updated-age" id="msg" role="alert">
        Your role has been updated to {{ new_role }} based on your current age.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{% endif %}

<div class="accounttitle-ribbon">
    <h1 class="accounttitle">Account</h1>
    <i class="fa-solid fa-gear fa-2xl Options-Account-Info" style="color: #ffffff;"></i> <!-- Link this to have change password and other account options-->
</div>

<div class="account-info">

    <div class="container accountbox">
        <p class="username-box"><strong>Username:</strong> {{ user.username }}</p>
        <p class="account-type-box"><strong>Account Type:</strong> {{ profile.role }} </p>
    </div>

    <div class="container account-stats">
        <p class="favourite-genre"><strong>Favourite Genre:</strong></p>
        <hr class="divider-line">
        <p class="favourite-genre-stat"> Based on % Read <!-- Based on % Read --> </p>

        <p class="favourite-genre"><strong>Favourite Author:</strong></p>
        <hr class="divider-line">
        <p class="favourite-genre-stat">  Based on % Read<!-- Based on % Read --> </p>
    </div>

    
    <div class="container account-purchases">
        <div class="card my-3">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#purchasedBooks" style="cursor: pointer;">
              <strong>Purchased Books</strong>
              <i class="fa-solid fa-chevron-down" id="collapseArrow"></i>
            </div>
            <div id="purchasedBooks" class="collapse show">
                <div class="card-body p-0" style="max-height: 200px; overflow-y: auto;">
                    <table class="table table-bordered m-0">
                        <thead class="table-light">
                            <tr>
                            <th>Book Title</th>
                            <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for book in profile.purchased_books.all %}
                            <tr>
                            <td>{{ book.booktitle }}</td>
                            <td>{{ book.bookprice }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                            <td colspan="3" class="text-center">No purchased books</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Extras -->
   
    <div class="container border p-3 rounded shadow-sm bg-light account-extra-box">
        <div class="d-flex justify-content-between top-options">
            <button id="btnSeeHidden" class="btn btn-outline-dark review-tab" onclick="showTab('hiddenTab')">See Hidden</button>
            <button id="btnYourReviews" class="btn btn-outline-dark see-hidden-tab" onclick="showTab('reviewTab')">Your Reviews</button>
        </div>
    
        <hr class="divider-line">

        <!-- See Hidden Section -->
        <div id="hiddenTab" class="tab-section">
            <div class="btn-group hidden-tab-section" role="group" id="hiddenGroup">
                <button class="btn btn-outline-secondary hidden-author-button" onclick="showHiddenSection('authorsSection', this)">Hidden Authors</button>
                <button class="btn btn-outline-secondary hidden-book-button" onclick="showHiddenSection('booksSection', this)">Hidden Books</button>
                <button class="btn btn-outline-secondary hidden-topic-button" onclick="showHiddenSection('topicsSection', this)">Hidden Topics</button>
            </div>
            
            <hr class="divider-line">

            <!-- Hidden Authors -->
            <div id="authorsSection" class="hidden-section tab-section">
                <h5>Hidden Authors</h5>
                {% for author in hidden_authors %} <!-- WONT WORK UNTIL WE HAVE THE ABILITY TO HIDE AUTHORS --> 
                    <div class="d-flex justify-content-between border p-2 my-2">
                        <span>{{ author.name }}</span>
                        <span>{{ author.hidden_date }}</span>
                        <i class="fa-solid fa-eye"></i> <!-- FAV ICON CHANGE, ADD FUCTIONALITY -->
                    </div>
                {% empty %}
                    <p>No hidden authors.</p>
                {% endfor %}
            </div>
    
            <!-- Hidden Books -->
            <div id="booksSection" class="hidden-section tab-section">
                <h5>Hidden Books</h5>
                {% if profile.hidden_books.all %}
                    {% for book in profile.hidden_books.all %}
                        <div class="d-flex justify-content-between border p-2 my-2">
                            <div>
                                <strong>{{ book.booktitle }}</strong><br>
                                <small>Author: {{ book.authorname }}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary unhide-book" data-book-id="{{ book.id }}">
                                <i class="fa-solid fa-eye"></i> Unhide
                            </button>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No hidden books.</p>
                {% endif %}
            </div>
    
            <!-- Hidden Topics -->
            <div id="topicsSection" class="hidden-section tab-section">
                <h5>Hidden Topics</h5>
                {% for topic in hidden_topics %} <!-- WONT WORK UNTIL WE HAVE THE ABILITY TO HIDE TOPICS --> 
                    <div class="d-flex justify-content-between border p-2 my-2">
                        <span>{{ topic.name }}</span>
                        <span>{{ topic.hidden_date }}</span>
                        <i class="fa-solid fa-eye"></i> <!-- FAV ICON CHANGE, ADD FUCTIONALITY -->
                    </div>
                {% empty %}
                    <p>No hidden topics.</p>
                {% endfor %}
            </div>
        </div>
    
        <!-- User Reviews Section -->
        <div id="reviewTab" class="tab-section">
            <h5>Your Reviews</h5>
            <p>Debug: Total comments in database: {{ all_comments_count }}</p>
            <p>Debug: Comments for current user: {{ user_comments_count }}</p>
            <p>Debug: Username: {{ user.username }}</p>
            {% if user_comments %}
                {% for comment in user_comments %}
                    <div class="border p-3 mb-3 rounded shadow-sm">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">{{ comment.title }}</h6>
                            <span class="badge bg-primary">{{ comment.rating }}/5</span>
                        </div>
                        <small class="text-muted">Reviewed on {{ comment.created_on|date:"F d, Y" }}</small>
                        <p class="mt-2">{{ comment.body|truncatechars:150 }}</p>
                        {% if comment.approved %}
                            <span class="badge bg-success">Approved</span>
                        {% else %}
                            <span class="badge bg-warning text-dark">Pending Approval</span>
                        {% endif %}
                        <a href="{% url 'book_details_list' comment.bookstorepage_id %}" class="btn btn-outline-primary btn-sm mt-2">Go to Book</a>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">You haven't written any reviews yet.</p>
            {% endif %}
        </div>

        
    </div>
</div>

<div class="fix-footer">
</div>

{% endblock content %}

{% block extras %}
<script src="{% static 'js/hiddenaccount.js' %}"></script>
{% endblock extras %}